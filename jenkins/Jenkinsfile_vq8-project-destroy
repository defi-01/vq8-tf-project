pipeline {
    agent any

    tools {
        terraform 'terraform'
    }

    parameters {
        choice(
            name: 'CONFIRM DESTROY',
            choices: ['NO', 'YES'],
            description: 'Confirm Infrastructure Destruction'
        )
    }

    environment {
        GITHUB_TOKEN = credentials('vq8-GitHub')
    }

    stages {

        stage('Apply Confirmation Check') {
            steps {
                script {
                    if (params["CONFIRM DESTROY"] != 'YES') {
                        error '‚ùå Apply Not Confirmed!‚ùå'
                    }
                }
            }
        }

        stage('Cloning vq8-project Repository') {
            steps {
                script {
                    sh 'rm -rf vq8-project'
                    sh 'git clone https://${GITHUB_TOKEN}@github.com/defi-01/vq8-project.git'
                }
            }
        }

        stage('Terraform Destroy Provisioning') {
            steps {
                dir('vq8-project/tf') {
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: 'vq8-aws',
                        accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                        secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                    ]]) {
                        sh 'terraform init'
                        sh 'terraform destroy -auto-approve'
                    }
                }
            }
        }

        stage('Terraform Results Provisioning') {
            steps {
                script {
                    def timestamp = sh(script: "date '+%Y-%m-%d %H:%M:%S'", returnStdout: true).trim()
                    
                    def output = """
========================================
        üí• TERRAFORM DESTROY RESULTS üí•
========================================
‚úÖ Infrastructure destruction completed successfully!
‚úÖ JOB: ${env.JOB_NAME}
‚úÖ Timestamp: ${timestamp}
========================================
             üéâ COMPLETE üéâ
========================================
"""
                    echo output
                }
            }
        }
    }

    post {
        always {
            script {
                sh 'rm -rf vq8-project'
                cleanWs()
            }
        }
    }
}
