---
- name: Setup Nginx and CloudWatch
  hosts: web
  become: true

  tasks:
    - name: Install Nginx
      apt:
        name: nginx
        state: present
        update_cache: yes

    - name: Enable and start Nginx
      systemd:
        name: nginx
        enabled: yes
        state: started

    - name: Create index.html with client IP
      copy:
        dest: /var/www/html/index.html
        content: "Your IP is: {{ ansible_host }}"

    - name: Download CloudWatch Agent
      get_url:
        url: https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
        dest: /tmp/amazon-cloudwatch-agent.deb
      when: ansible_facts['os_family'] == "Debian"

    - name: Install CloudWatch Agent DEB
      apt:
        deb: /tmp/amazon-cloudwatch-agent.deb
        state: present
      when: ansible_facts['os_family'] == "Debian"

    - name: Upload CloudWatch config
      copy:
        src: cloudwatch-config.json
        dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

    - name: Start CloudWatch Agent
      shell: |
        /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
          -a fetch-config -m ec2 \
          -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json \
          -s
