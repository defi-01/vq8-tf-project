---
- name: Setup Nginx and CloudWatch
  hosts: web
  become: true

  tasks:
    - name: Install Nginx
      yum:
        name: nginx
        state: present

    - name: Enable and start Nginx
      systemd:
        name: nginx
        enabled: yes
        state: started

    - name: Create index.html with client IP
      copy:
        dest: /usr/share/nginx/html/index.html
        content: "Your IP is: {{ ansible_host }}"

    - name: Install CloudWatch Agent
      amazon.aws.aws_s3:
        bucket: amazoncloudwatch-agent
        object: amazon-cloudwatch-agent.rpm
        dest: /tmp/amazon-cloudwatch-agent.rpm
        mode: get
      when: ansible_facts['os_family'] == "RedHat"

    - name: Install RPM
      yum:
        name: /tmp/amazon-cloudwatch-agent.rpm
        state: present

    - name: Upload CloudWatch config
      copy:
        src: cloudwatch-config.json
        dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

    - name: Start CloudWatch Agent
      shell: |
        /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
          -a fetch-config -m ec2 \
          -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json \
          -s